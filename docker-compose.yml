version: "3.6"
services:
    db:
        image: "postgres:16"
        ports:
            - "5432:5432"
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        volumes:
            - postgres_data:/var/lib/postgresql/data
    rabbitmq:
        image: "rabbitmq:3-management"
        ports:
          - "5672:5672"
          - "15672:15672"
    mailhog:
        image: mailhog/mailhog
        ports: 
          - 1025:1025 # smtp server
          - 8025:8025 # web ui
    redis:
        image: "redis:7-alpine"
        ports:
          - "6379:6379"
        volumes:
          - redis_data:/data
        command: redis-server --appendonly yes
    migrator:
        image: classifiedads.modularmonolith.migrator
        build:
          context: .
          dockerfile: ./ClassifiedAds.Migrator/Dockerfile
        depends_on:
          - db
        environment:
          DOTNET_ENVIRONMENT: ${DOTNET_ENVIRONMENT}
          ConnectionStrings__Default: ${ConnectionStrings__Default}
          CheckDependency__Enabled: "true"
          CheckDependency__Host: "db:5432"
    webapi:
        image: classifiedads.modularmonolith.webapi
        build:
          context: .
          dockerfile: ./ClassifiedAds.WebAPI/Dockerfile
        ports:
            - "9002:8080"
        depends_on:
          - db
          - migrator
          - rabbitmq
        environment:
          ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
          ConnectionStrings__Default: ${ConnectionStrings__Default}
          Modules__Storage__Provider: ${Storage__Provider}
          Modules__Storage__Local__Path: ${Storage__Local__Path}
    background:
        image: classifiedads.modularmonolith.background
        build:
          context: .
          dockerfile: ./ClassifiedAds.Background/Dockerfile
        depends_on:
          - db
          - migrator
          - rabbitmq
          - mailhog
        environment:
          DOTNET_ENVIRONMENT: ${DOTNET_ENVIRONMENT}
          CheckDependency__Enabled: "true"
          CheckDependency__Host: "rabbitmq:5672"
          Messaging__Provider: ${Messaging__Provider}
          Messaging__RabbitMQ__HostName: ${Messaging__RabbitMQ__HostName}
          ConnectionStrings__Default: ${ConnectionStrings__Default}
          Modules__Notification__Email__Provider: "SmtpClient"
          Modules__Notification__Email__SmtpClient__Host: "mailhog"
          Modules__Notification__Email__SmtpClient__Port: "1025"
          Modules__Notification__Email__SmtpClient__EnableSsl: "false"
          Modules__Notification__EmailQueue__ChannelCapacity: "64"
          Modules__Notification__EmailQueue__MaxDegreeOfParallelism: "3"
          Modules__Notification__EmailQueue__MaxRetryAttempts: "5"
          Modules__Notification__EmailQueue__SendTimeoutSeconds: "30"
          Modules__Notification__Sms__Provider: "Fake"
          Modules__Notification__Sms__Twilio__AccountSId: ""
          Modules__Notification__Sms__Twilio__AuthToken: ""
          Modules__Notification__Sms__Twilio__FromNumber: ""
          Modules__Notification__Web__Provider: "Fake"
          Modules__Notification__Web__SignalR__Endpoint: "http://notificationserver"
          Modules__Storage__Provider: ${Storage__Provider}
          Modules__Storage__Local__Path: ${Storage__Local__Path}

volumes:
    postgres_data:
    redis_data:
