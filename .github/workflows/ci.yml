# ============================================================================
# CI Pipeline - Continuous Integration
# ============================================================================
# Triggers: Pull Requests and Push to main branch
# Jobs: Build, Lint (StyleCop), Test, Docker Build Validation
# ============================================================================

name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "docs-architecture/**"
      - ".github/CODEOWNERS"
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "docs-architecture/**"

# Prevent concurrent CI runs on same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# Minimal permissions for GITHUB_TOKEN
permissions:
  contents: read
  pull-requests: read

env:
  DOTNET_VERSION: "10.0.x"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

jobs:
  # ============================================================================
  # Build & Lint Job
  # ============================================================================
  build:
    name: Build & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/Directory.Build.props', '**/Directory.Packages.props') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore dependencies
        run: dotnet restore ClassifiedAds.ModularMonolith.slnx

      - name: Build solution
        run: dotnet build ClassifiedAds.ModularMonolith.slnx --configuration Release --no-restore

      - name: Check code formatting
        run: dotnet format ClassifiedAds.ModularMonolith.slnx --verify-no-changes --verbosity diagnostic
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/bin/Release/**
            !**/obj/**
          retention-days: 7
          if-no-files-found: warn

  # ============================================================================
  # Test Job (when tests are added)
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ env.NUGET_PACKAGES }}
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/Directory.Build.props', '**/Directory.Packages.props') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore dependencies
        run: dotnet restore ClassifiedAds.ModularMonolith.slnx

      # Placeholder: Enable when test projects are added
      # - name: Run unit tests
      #   run: dotnet test ClassifiedAds.ModularMonolith.slnx --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage"

      # - name: Upload test results
      #   uses: actions/upload-artifact@v4
      #   if: always()
      #   with:
      #     name: test-results
      #     path: '**/TestResults/**'
      #     retention-days: 7

      - name: Tests placeholder
        run: echo "⚠️ No test projects found. Add test projects and uncomment test steps above."

  # ============================================================================
  # Docker Build Validation
  # ============================================================================
  docker-build:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    needs: build

    strategy:
      matrix:
        include:
          - service: webapi
            dockerfile: ClassifiedAds.WebAPI/Dockerfile
            context: .
          - service: background
            dockerfile: ClassifiedAds.Background/Dockerfile
            context: .
          - service: migrator
            dockerfile: ClassifiedAds.Migrator/Dockerfile
            context: .

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (${{ matrix.service }})
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: false
          tags: classifiedads-${{ matrix.service }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # Security Scanning (Optional - Enable when needed)
  # ============================================================================
  # security-scan:
  #   name: Security Scan
  #   runs-on: ubuntu-latest
  #   needs: build
  #   permissions:
  #     security-events: write
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Initialize CodeQL
  #       uses: github/codeql-action/init@v3
  #       with:
  #         languages: csharp
  #
  #     - name: Build for CodeQL
  #       run: dotnet build ClassifiedAds.ModularMonolith.slnx
  #
  #     - name: Perform CodeQL Analysis
  #       uses: github/codeql-action/analyze@v3
