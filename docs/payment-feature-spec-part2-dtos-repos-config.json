{
  "$schema": "payment-feature-specification",
  "version": "1.1.0",
  "title": "StudentGamerHub Payment Feature - DTOs, Repository & Configuration",
  "part": "2/3 - DTOs, Repository, Configuration",

  "dtos": {
    "PaymentIntentDto": {
      "file": "DTOs/Registrations/PaymentIntentDto.cs",
      "description": "DTO returned when querying a payment intent",
      "code": "namespace DTOs.Registrations;\n\npublic sealed record PaymentIntentDto(\n    Guid Id,\n    long AmountCents,\n    PaymentPurpose Purpose,\n    Guid? EventRegistrationId,\n    Guid? EventId,\n    PaymentIntentStatus Status,\n    DateTime ExpiresAt,\n    string ClientSecret,\n    string? ProviderName,\n    string? TransactionId,\n    string? MetadataJson,\n    long OrderCode,\n    DateTime CreatedAt);"
    },
    "MembershipPurchaseResultDto": {
      "file": "DTOs/Memberships/MembershipPlanDtos.cs (bottom of file)",
      "code": "public sealed record MembershipPurchaseResultDto(\n    bool RequiresExternalPayment,\n    Guid? PaymentIntentId,\n    UserMembershipInfoDto? Membership);\n\npublic sealed record UserMembershipInfoDto(\n    Guid MembershipPlanId,\n    string PlanName,\n    int MonthlyEventLimit,\n    DateTime StartDate,\n    DateTime EndDate,\n    int? RemainingEventQuota,\n    bool IsActive);"
    },
    "PayOsCreatePaymentRequest": {
      "file": "DTOs/Payments/PayOs/PayOsCreatePaymentRequest.cs",
      "description": "Request DTO sent to PayOS API to create a payment link",
      "code": "namespace DTOs.Payments.PayOs;\n\npublic sealed record PayOsCreatePaymentRequest\n{\n    public required long OrderCode { get; init; }\n    public required long Amount { get; init; }\n    public string Description { get; init; } = string.Empty;\n    public string ReturnUrl { get; init; } = string.Empty;\n    public string CancelUrl { get; init; } = string.Empty;\n    public string? WebhookUrl { get; init; }\n    public string? BuyerName { get; init; }\n    public string? BuyerEmail { get; init; }\n    public string? BuyerPhone { get; init; }\n}"
    },
    "PayOsPaymentResponse": {
      "file": "DTOs/Payments/PayOs/PayOsPaymentResponse.cs",
      "description": "Response from PayOS API when creating payment link",
      "code": "namespace DTOs.Payments.PayOs;\n\npublic sealed record PayOsPaymentResponse\n{\n    public string Code { get; init; } = \"\";\n    public string Desc { get; init; } = \"\";\n    public bool Success { get; init; }\n    public PayOsPaymentResponseData? Data { get; init; }\n    public sealed record PayOsPaymentResponseData\n    {\n        public string? CheckoutUrl { get; init; }\n        public long? OrderCode { get; init; }\n        public string? PaymentLinkId { get; init; }\n    }\n}"
    },
    "PayOsWebhookPayload": {
      "file": "DTOs/Payments/PayOs/PayOsWebhookPayload.cs",
      "description": "Webhook payload sent by PayOS when payment status changes",
      "code": "using System.Text.Json.Serialization;\n\nnamespace DTOs.Payments.PayOs;\n\npublic sealed record PayOsWebhookPayload\n{\n    [JsonPropertyName(\"code\")]\n    public string Code { get; init; } = \"\";\n\n    [JsonPropertyName(\"desc\")]\n    public string Desc { get; init; } = \"\";\n\n    [JsonPropertyName(\"success\")]\n    public bool Success { get; init; }\n\n    [JsonPropertyName(\"data\")]\n    public PayOsWebhookData Data { get; init; } = new();\n\n    [JsonPropertyName(\"signature\")]\n    public string Signature { get; init; } = \"\";\n}\n\npublic sealed record PayOsWebhookData\n{\n    [JsonPropertyName(\"orderCode\")]\n    public long OrderCode { get; init; }\n\n    [JsonPropertyName(\"amount\")]\n    public long Amount { get; init; }\n\n    [JsonPropertyName(\"description\")]\n    public string Description { get; init; } = \"\";\n\n    [JsonPropertyName(\"reference\")]\n    public string? Reference { get; init; }\n\n    [JsonPropertyName(\"transactionDateTime\")]\n    public string TransactionDateTime { get; init; } = \"\";\n\n    [JsonPropertyName(\"currency\")]\n    public string Currency { get; init; } = \"VND\";\n\n    [JsonPropertyName(\"paymentLinkId\")]\n    public string? PaymentLinkId { get; init; }\n\n    [JsonPropertyName(\"accountNumber\")]\n    public string? AccountNumber { get; init; }\n\n    [JsonPropertyName(\"counterAccountBankId\")]\n    public string? CounterAccountBankId { get; init; }\n\n    [JsonPropertyName(\"counterAccountBankName\")]\n    public string? CounterAccountBankName { get; init; }\n\n    [JsonPropertyName(\"counterAccountName\")]\n    public string? CounterAccountName { get; init; }\n\n    [JsonPropertyName(\"counterAccountNumber\")]\n    public string? CounterAccountNumber { get; init; }\n\n    [JsonPropertyName(\"virtualAccountName\")]\n    public string? VirtualAccountName { get; init; }\n\n    [JsonPropertyName(\"virtualAccountNumber\")]\n    public string? VirtualAccountNumber { get; init; }\n\n    [JsonPropertyName(\"code\")]\n    public string? Code { get; init; }\n\n    [JsonPropertyName(\"desc\")]\n    public string? Desc { get; init; }\n}"
    },
    "PayOsWebhookOutcome": {
      "file": "Services/Interfaces/PayOsWebhookOutcome.cs",
      "code": "namespace Services.Interfaces;\n\npublic enum PayOsWebhookOutcome\n{\n    Processed = 0,\n    Ignored = 1\n}"
    },
    "PayOsCheckoutRequest": {
      "file": "WebAPI/Controllers/PaymentsController.cs (inline record)",
      "description": "Request body for POST /api/payments/payos/create",
      "code": "public sealed record PayOsCheckoutRequest\n{\n    public Guid IntentId { get; init; }\n    public string? ReturnUrl { get; init; }\n}"
    },
    "AdminPaymentIntentDto": {
      "file": "DTOs/Admin/AdminPaymentIntentDto.cs",
      "description": "Detailed payment intent info for admin dashboard",
      "code": "using BusinessObjects;\n\nnamespace DTOs.Admin;\n\npublic record AdminPaymentIntentDto\n{\n    public Guid Id { get; init; }\n    public Guid UserId { get; init; }\n    public string? UserName { get; init; }\n    public string? UserEmail { get; init; }\n    public long AmountCents { get; init; }\n    public PaymentPurpose Purpose { get; init; }\n    public string PurposeDisplay { get; init; } = string.Empty;\n    public Guid? EventId { get; init; }\n    public string? EventTitle { get; init; }\n    public Guid? EventRegistrationId { get; init; }\n    public Guid? MembershipPlanId { get; init; }\n    public string? MembershipPlanName { get; init; }\n    public PaymentIntentStatus Status { get; init; }\n    public string StatusDisplay { get; init; } = string.Empty;\n    public long? OrderCode { get; init; }\n    public DateTime ExpiresAt { get; init; }\n    public DateTime CreatedAtUtc { get; init; }\n    public DateTime? UpdatedAtUtc { get; init; }\n}"
    },
    "AdminPaymentIntentFilter": {
      "file": "DTOs/Admin/Filters/AdminPaymentIntentFilter.cs",
      "code": "using BusinessObjects;\n\nnamespace DTOs.Admin.Filters;\n\npublic class AdminPaymentIntentFilter\n{\n    public Guid? UserId { get; set; }\n    public Guid? EventId { get; set; }\n    public Guid? MembershipPlanId { get; set; }\n    public PaymentPurpose? Purpose { get; set; }\n    public PaymentIntentStatus? Status { get; set; }\n    public DateTime? FromDate { get; set; }\n    public DateTime? ToDate { get; set; }\n    public string? Period { get; set; }\n    public long? MinAmountCents { get; set; }\n    public long? MaxAmountCents { get; set; }\n    public long? OrderCode { get; set; }\n}"
    }
  },

  "repository": {
    "IPaymentIntentRepository": {
      "file": "Repositories/Interfaces/IPaymentIntentRepository.cs",
      "code": "namespace Repositories.Interfaces;\n\npublic interface IPaymentIntentRepository\n{\n    Task<PaymentIntent?> GetByIdAsync(Guid id, CancellationToken ct = default);\n    Task<PaymentIntent?> GetByIdForUserAsync(Guid id, Guid userId, CancellationToken ct = default);\n    Task<PaymentIntent?> GetByProviderRefAsync(string providerRef, CancellationToken ct = default);\n    Task CreateAsync(PaymentIntent pi, CancellationToken ct = default);\n    Task UpdateAsync(PaymentIntent pi, CancellationToken ct = default);\n    Task<int> CountActivePendingByEventAsync(Guid eventId, DateTime nowUtc, CancellationToken ct = default);\n    Task<PaymentIntent?> GetByOrderCodeAsync(long orderCode, CancellationToken ct = default);\n    Task<bool> TrySetOrderCodeAsync(Guid id, long orderCode, CancellationToken ct = default);\n    Task<bool> HasActiveTopUpIntentAsync(Guid eventId, Guid userId, CancellationToken ct = default);\n}"
    },
    "PaymentIntentRepository": {
      "file": "Repositories/Implements/PaymentIntentRepository.cs",
      "code": "using Microsoft.EntityFrameworkCore;\n\nnamespace Repositories.Implements;\n\npublic sealed class PaymentIntentRepository : IPaymentIntentRepository\n{\n    private readonly AppDbContext _context;\n\n    public PaymentIntentRepository(AppDbContext context)\n    {\n        _context = context ?? throw new ArgumentNullException(nameof(context));\n    }\n\n    public Task<PaymentIntent?> GetByIdAsync(Guid id, CancellationToken ct = default)\n        => _context.PaymentIntents\n            .AsNoTracking()\n            .FirstOrDefaultAsync(pi => pi.Id == id, ct);\n\n    public Task<PaymentIntent?> GetByIdForUserAsync(Guid id, Guid userId, CancellationToken ct = default)\n        => _context.PaymentIntents\n            .Where(pi => pi.UserId == userId && pi.Id == id)\n            .Include(pi => pi.EventRegistration)\n                .ThenInclude(r => r.PaidTransaction)\n            .AsNoTracking()\n            .FirstOrDefaultAsync(ct);\n\n    public Task<PaymentIntent?> GetByProviderRefAsync(string providerRef, CancellationToken ct = default)\n        => _context.PaymentIntents\n            .AsNoTracking()\n            .FirstOrDefaultAsync(pi => pi.ClientSecret == providerRef, ct);\n\n    public async Task CreateAsync(PaymentIntent pi, CancellationToken ct = default)\n    {\n        ArgumentNullException.ThrowIfNull(pi);\n        await _context.PaymentIntents.AddAsync(pi, ct).ConfigureAwait(false);\n    }\n\n    public Task UpdateAsync(PaymentIntent pi, CancellationToken ct = default)\n    {\n        ArgumentNullException.ThrowIfNull(pi);\n        _context.PaymentIntents.Update(pi);\n        return Task.CompletedTask;\n    }\n\n    public Task<int> CountActivePendingByEventAsync(Guid eventId, DateTime nowUtc, CancellationToken ct = default)\n    {\n        return _context.EventRegistrations\n            .AsNoTracking()\n            .Where(r => r.EventId == eventId && r.Status == EventRegistrationStatus.Pending)\n            .Join(\n                _context.PaymentIntents.AsNoTracking(),\n                r => r.Id,\n                pi => pi.EventRegistrationId,\n                (r, pi) => new { Registration = r, Intent = pi })\n            .Where(x => x.Intent.Purpose == PaymentPurpose.EventTicket &&\n                        x.Intent.Status == PaymentIntentStatus.RequiresPayment &&\n                        x.Intent.ExpiresAt > nowUtc)\n            .CountAsync(ct);\n    }\n\n    public async Task<PaymentIntent?> GetByOrderCodeAsync(long orderCode, CancellationToken ct = default)\n    {\n        return await _context.PaymentIntents\n            .AsNoTracking()\n            .FirstOrDefaultAsync(x => x.OrderCode == orderCode, ct);\n    }\n\n    public async Task<bool> TrySetOrderCodeAsync(Guid id, long orderCode, CancellationToken ct = default)\n    {\n        try\n        {\n            var updated = await _context.PaymentIntents\n                .Where(x => x.Id == id && x.OrderCode == null)\n                .ExecuteUpdateAsync(\n                    setters => setters.SetProperty(pi => pi.OrderCode, orderCode),\n                    ct).ConfigureAwait(false);\n\n            if (updated > 0) return true;\n\n            return await _context.PaymentIntents\n                .AsNoTracking()\n                .AnyAsync(x => x.Id == id && x.OrderCode.HasValue, ct).ConfigureAwait(false);\n        }\n        catch (InvalidOperationException ex) when (ex.Message.Contains(\"ExecuteUpdate\", StringComparison.OrdinalIgnoreCase))\n        {\n            var entity = await _context.PaymentIntents.FirstOrDefaultAsync(x => x.Id == id, ct).ConfigureAwait(false);\n            if (entity is null) return false;\n            if (entity.OrderCode.HasValue) return entity.OrderCode.Value == orderCode;\n            entity.OrderCode = orderCode;\n            try\n            {\n                await _context.SaveChangesAsync(ct).ConfigureAwait(false);\n                _context.Entry(entity).State = EntityState.Detached;\n                return true;\n            }\n            catch (DbUpdateException retryEx) when (retryEx.IsUniqueConstraintViolation())\n            {\n                _context.Entry(entity).State = EntityState.Detached;\n                return false;\n            }\n        }\n        catch (DbUpdateException ex) when (ex.IsUniqueConstraintViolation())\n        {\n            return false;\n        }\n    }\n\n    public Task<bool> HasActiveTopUpIntentAsync(Guid eventId, Guid userId, CancellationToken ct = default)\n    {\n        return _context.PaymentIntents\n            .AsNoTracking()\n            .AnyAsync(pi =>\n                pi.EventId == eventId &&\n                pi.UserId == userId &&\n                pi.Purpose == PaymentPurpose.TopUp &&\n                (pi.Status == PaymentIntentStatus.RequiresPayment || pi.Status == PaymentIntentStatus.Succeeded),\n                ct);\n    }\n}"
    }
  },

  "configuration": {
    "PayOsOptions": {
      "file": "Services/Configuration/PayOsOptions.cs",
      "code": "namespace Services.Configuration;\n\npublic sealed class PayOsOptions\n{\n    private string _secretKey = string.Empty;\n\n    public string ClientId { get; set; } = string.Empty;\n    public string ApiKey { get; set; } = string.Empty;\n\n    public string SecretKey\n    {\n        get => _secretKey;\n        set => _secretKey = value?.Trim() ?? string.Empty;\n    }\n\n    // Back-compat aliases\n    public string ChecksumKey { get => SecretKey; set => SecretKey = value; }\n    public string WebhookSecret { get => SecretKey; set => SecretKey = value; }\n\n    public string BaseUrl { get; set; } = \"https://api-merchant.payos.vn\";\n    public string ReturnUrl { get; set; } = string.Empty;\n    public string WebhookUrl { get; set; } = string.Empty;\n    public string? CancelUrl { get; set; }\n    public string FrontendBaseUrl { get; set; } = string.Empty;\n    public TimeSpan WebhookTolerance { get; set; } = TimeSpan.FromMinutes(5);\n}",
      "appsettingsExample": {
        "PayOS": {
          "ClientId": "your-client-id-from-payos-dashboard",
          "ApiKey": "your-api-key-from-payos-dashboard",
          "SecretKey": "your-secret-key-from-payos-dashboard",
          "BaseUrl": "https://api-merchant.payos.vn",
          "ReturnUrl": "https://your-api-domain.com/api/payments/payos/return",
          "WebhookUrl": "https://your-api-domain.com/api/payments/payos/webhook",
          "CancelUrl": "https://your-frontend.com/payment/cancel",
          "FrontendBaseUrl": "https://your-frontend.com"
        }
      }
    },
    "BillingOptions": {
      "file": "Services/Configuration/BillingOptions.cs",
      "description": "Only the fields relevant to payments are shown",
      "code": "namespace Services.Configuration;\n\npublic sealed class BillingOptions\n{\n    public const string SectionName = \"Billing\";\n    public long EventCreationFeeCents { get; set; } = 50_000;\n    public Guid? PlatformUserId { get; set; }\n    public string PlatformUserEmail { get; set; } = \"platform@studentgamerhub.local\";\n    public string PlatformUserName { get; set; } = \"Platform Wallet\";\n    public long MaxEventEscrowTopUpAmountCents { get; set; } = 50_000_000;\n    public long MaxWalletTopUpAmountCents { get; set; } = 20_000_000;\n}"
    },
    "dependencyInjection": {
      "file": "WebAPI/Extensions/ServiceCollectionExtensions.cs",
      "registrations": [
        "services.Configure<Services.Configuration.PayOsOptions>(configuration.GetSection(\"PayOS\"));",
        "services.Configure<Services.Configuration.BillingOptions>(configuration.GetSection(\"Billing\"));",
        "services.AddHttpClient<IPayOsService, Services.Implementations.PayOsService>();",
        "services.AddScoped<IPaymentService, Services.Implementations.PaymentService>();",
        "services.AddScoped<IPaymentReadService, Services.Implementations.PaymentReadService>();",
        "services.AddScoped<IPaymentIntentRepository, Repositories.Implements.PaymentIntentRepository>();",
        "services.AddScoped<ITransactionRepository, Repositories.Implements.TransactionRepository>();"
      ],
      "notes": [
        "PayOsService registered via AddHttpClient (typed HttpClient pattern)",
        "IConnectionMultiplexer (Redis) is optional - injected as null if not configured",
        "FluentValidation validators auto-registered via AddValidatorsFromAssembly"
      ]
    },
    "rateLimiting": {
      "policies": {
        "PaymentsWrite": "Strict rate limit for payment write operations",
        "PaymentsWebhook": "Rate limit for incoming webhooks from PayOS",
        "ReadsLight": "Standard rate limit for read operations"
      }
    }
  },

  "helperExtensions": {
    "ClaimsPrincipalExtensions": {
      "file": "Services/Common/Auth/ClaimsPrincipalExtensions.cs",
      "code": "using System.Security.Claims;\n\nnamespace Services.Common.Auth\n{\n    public static class ClaimsPrincipalExtensions\n    {\n        public static Guid? GetUserId(this ClaimsPrincipal? user)\n        {\n            if (user is null) return null;\n            foreach (var t in new[] { ClaimTypes.NameIdentifier, \"sub\", \"uid\" })\n            {\n                var v = user.FindFirst(t)?.Value;\n                if (!string.IsNullOrWhiteSpace(v) && Guid.TryParse(v, out var id))\n                    return id;\n            }\n            return null;\n        }\n    }\n}"
    },
    "ResultHttpExtensions": {
      "file": "WebAPI/Common/ResultHttpExtensions.cs",
      "description": "Maps Result<T> to ASP.NET Core ActionResult with proper HTTP status codes",
      "code": "using Microsoft.AspNetCore.Mvc;\n\nnamespace WebApi.Common;\n\npublic static class ResultHttpExtensions\n{\n    public static ActionResult ToActionResult(this ControllerBase ctrl, Result r)\n    {\n        if (r.IsSuccess) return ctrl.NoContent();\n        return ctrl.Problem(r.Error);\n    }\n\n    public static ActionResult ToActionResult<T>(this ControllerBase ctrl, Result<T> r, Func<T, object?>? shape = null, int successStatus = StatusCodes.Status200OK)\n    {\n        if (r.IsSuccess)\n        {\n            var payload = shape is null ? r.Value : shape(r.Value!);\n            return ctrl.StatusCode(successStatus, payload);\n        }\n        return ctrl.Problem(r.Error);\n    }\n}"
    }
  }
}
