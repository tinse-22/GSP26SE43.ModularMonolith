{
  "$schema": "payment-feature-specification",
  "version": "2.0.0",
  "title": "ClassifiedAds.ModularMonolith Payment Feature - Models (DTOs), Configuration & DI",
  "part": "2/3 - Models (DTOs), PayOS Configuration, DI Registration",

  "models": {
    "_note": "Dự án sử dụng 'Models' thay vì 'DTOs'. Request models dùng DataAnnotations validation. Response models là POCOs đơn giản. Manual mapping qua extension methods.",

    "PaymentIntentModel": {
      "file": "ClassifiedAds.Modules.Subscription/Models/PaymentIntentModel.cs",
      "description": "Response DTO cho PaymentIntent",
      "code": "using ClassifiedAds.Modules.Subscription.Entities;\nusing System;\n\nnamespace ClassifiedAds.Modules.Subscription.Models;\n\npublic class PaymentIntentModel\n{\n    public Guid Id { get; set; }\n\n    public Guid UserId { get; set; }\n\n    public decimal Amount { get; set; }\n\n    public string Currency { get; set; }\n\n    public PaymentPurpose Purpose { get; set; }\n\n    public Guid PlanId { get; set; }\n\n    public string PlanName { get; set; }\n\n    public BillingCycle BillingCycle { get; set; }\n\n    public Guid? SubscriptionId { get; set; }\n\n    public PaymentIntentStatus Status { get; set; }\n\n    public string CheckoutUrl { get; set; }\n\n    public DateTimeOffset ExpiresAt { get; set; }\n\n    public long? OrderCode { get; set; }\n\n    public DateTimeOffset CreatedDateTime { get; set; }\n\n    public DateTimeOffset? UpdatedDateTime { get; set; }\n}"
    },

    "SubscriptionPurchaseResultModel": {
      "file": "ClassifiedAds.Modules.Subscription/Models/SubscriptionPurchaseResultModel.cs",
      "description": "Kết quả mua subscription - cho biết cần thanh toán hay đã xong",
      "code": "using System;\n\nnamespace ClassifiedAds.Modules.Subscription.Models;\n\npublic class SubscriptionPurchaseResultModel\n{\n    /// <summary>True nếu cần thanh toán qua PayOS.</summary>\n    public bool RequiresPayment { get; set; }\n\n    /// <summary>PaymentIntent ID (nếu cần thanh toán).</summary>\n    public Guid? PaymentIntentId { get; set; }\n\n    /// <summary>Subscription info (nếu free plan, đã active ngay).</summary>\n    public SubscriptionModel Subscription { get; set; }\n}"
    },

    "CreateSubscriptionPaymentModel": {
      "file": "ClassifiedAds.Modules.Subscription/Models/CreateSubscriptionPaymentModel.cs",
      "description": "Request DTO cho việc mua/upgrade subscription",
      "code": "using ClassifiedAds.Modules.Subscription.Entities;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace ClassifiedAds.Modules.Subscription.Models;\n\npublic class CreateSubscriptionPaymentModel\n{\n    /// <summary>Billing cycle: Monthly hoặc Yearly.</summary>\n    [Required]\n    public BillingCycle BillingCycle { get; set; } = BillingCycle.Monthly;\n}"
    },

    "PayOsCheckoutModel": {
      "file": "ClassifiedAds.Modules.Subscription/Models/PayOsCheckoutModel.cs",
      "description": "Request/Response models cho PayOS checkout",
      "code": "using System;\nusing System.ComponentModel.DataAnnotations;\n\nnamespace ClassifiedAds.Modules.Subscription.Models;\n\n/// <summary>\n/// Request body for POST /api/payments/payos/create.\n/// </summary>\npublic class PayOsCheckoutRequestModel\n{\n    [Required]\n    public Guid IntentId { get; set; }\n\n    [StringLength(500)]\n    public string ReturnUrl { get; set; }\n}\n\n/// <summary>\n/// Response from PayOS checkout creation.\n/// </summary>\npublic class PayOsCheckoutResponseModel\n{\n    public string CheckoutUrl { get; set; }\n\n    public long OrderCode { get; set; }\n}"
    },

    "PayOsModels": {
      "file": "ClassifiedAds.Modules.Subscription/Models/PayOsModels.cs",
      "description": "Internal models cho PayOS API communication",
      "code": "using System.Text.Json.Serialization;\n\nnamespace ClassifiedAds.Modules.Subscription.Models;\n\n/// <summary>\n/// Request payload gửi tới PayOS API v2 để tạo payment link.\n/// </summary>\npublic class PayOsCreatePaymentRequest\n{\n    public long OrderCode { get; set; }\n\n    public long Amount { get; set; }\n\n    public string Description { get; set; } = string.Empty;\n\n    public string ReturnUrl { get; set; } = string.Empty;\n\n    public string CancelUrl { get; set; } = string.Empty;\n\n    public string BuyerName { get; set; }\n\n    public string BuyerEmail { get; set; }\n\n    public string BuyerPhone { get; set; }\n}\n\n/// <summary>\n/// Response từ PayOS API khi tạo payment link.\n/// </summary>\npublic class PayOsPaymentResponse\n{\n    [JsonPropertyName(\"code\")]\n    public string Code { get; set; } = \"\";\n\n    [JsonPropertyName(\"desc\")]\n    public string Desc { get; set; } = \"\";\n\n    [JsonPropertyName(\"data\")]\n    public PayOsPaymentResponseData Data { get; set; }\n}\n\npublic class PayOsPaymentResponseData\n{\n    [JsonPropertyName(\"checkoutUrl\")]\n    public string CheckoutUrl { get; set; }\n\n    [JsonPropertyName(\"orderCode\")]\n    public long? OrderCode { get; set; }\n\n    [JsonPropertyName(\"paymentLinkId\")]\n    public string PaymentLinkId { get; set; }\n}\n\n/// <summary>\n/// Response từ PayOS API khi query payment info.\n/// </summary>\npublic class PayOsGetPaymentResponse\n{\n    [JsonPropertyName(\"code\")]\n    public string Code { get; set; } = \"\";\n\n    [JsonPropertyName(\"data\")]\n    public PayOsGetPaymentData Data { get; set; }\n}\n\npublic class PayOsGetPaymentData\n{\n    [JsonPropertyName(\"id\")]\n    public string Id { get; set; }\n\n    [JsonPropertyName(\"orderCode\")]\n    public long OrderCode { get; set; }\n\n    [JsonPropertyName(\"amount\")]\n    public long Amount { get; set; }\n\n    [JsonPropertyName(\"status\")]\n    public string Status { get; set; }\n\n    [JsonPropertyName(\"reference\")]\n    public string Reference { get; set; }\n\n    [JsonPropertyName(\"transactionDateTime\")]\n    public string TransactionDateTime { get; set; }\n}\n\n/// <summary>\n/// Kết quả xử lý webhook.\n/// </summary>\npublic enum PayOsWebhookOutcome\n{\n    Processed = 0,\n    Ignored = 1\n}"
    },

    "PayOsWebhookPayload": {
      "file": "ClassifiedAds.Modules.Subscription/Models/PayOsWebhookPayload.cs",
      "description": "Webhook payload từ PayOS khi trạng thái thanh toán thay đổi",
      "code": "using System.Text.Json.Serialization;\n\nnamespace ClassifiedAds.Modules.Subscription.Models;\n\n/// <summary>\n/// Webhook payload sent by PayOS when payment status changes.\n/// </summary>\npublic class PayOsWebhookPayload\n{\n    [JsonPropertyName(\"code\")]\n    public string Code { get; set; } = \"\";\n\n    [JsonPropertyName(\"desc\")]\n    public string Desc { get; set; } = \"\";\n\n    [JsonPropertyName(\"success\")]\n    public bool Success { get; set; }\n\n    [JsonPropertyName(\"data\")]\n    public PayOsWebhookData Data { get; set; }\n\n    [JsonPropertyName(\"signature\")]\n    public string Signature { get; set; } = \"\";\n}\n\npublic class PayOsWebhookData\n{\n    [JsonPropertyName(\"orderCode\")]\n    public long OrderCode { get; set; }\n\n    [JsonPropertyName(\"amount\")]\n    public long Amount { get; set; }\n\n    [JsonPropertyName(\"description\")]\n    public string Description { get; set; } = \"\";\n\n    [JsonPropertyName(\"reference\")]\n    public string Reference { get; set; }\n\n    [JsonPropertyName(\"transactionDateTime\")]\n    public string TransactionDateTime { get; set; } = \"\";\n\n    [JsonPropertyName(\"currency\")]\n    public string Currency { get; set; } = \"VND\";\n\n    [JsonPropertyName(\"paymentLinkId\")]\n    public string PaymentLinkId { get; set; }\n\n    [JsonPropertyName(\"accountNumber\")]\n    public string AccountNumber { get; set; }\n\n    [JsonPropertyName(\"counterAccountBankId\")]\n    public string CounterAccountBankId { get; set; }\n\n    [JsonPropertyName(\"counterAccountBankName\")]\n    public string CounterAccountBankName { get; set; }\n\n    [JsonPropertyName(\"counterAccountName\")]\n    public string CounterAccountName { get; set; }\n\n    [JsonPropertyName(\"counterAccountNumber\")]\n    public string CounterAccountNumber { get; set; }\n\n    [JsonPropertyName(\"virtualAccountName\")]\n    public string VirtualAccountName { get; set; }\n\n    [JsonPropertyName(\"virtualAccountNumber\")]\n    public string VirtualAccountNumber { get; set; }\n\n    [JsonPropertyName(\"code\")]\n    public string Code { get; set; }\n\n    [JsonPropertyName(\"desc\")]\n    public string Desc { get; set; }\n}"
    },

    "PaymentIntentModelMappingConfiguration": {
      "file": "ClassifiedAds.Modules.Subscription/Models/PaymentIntentModelMappingConfiguration.cs",
      "description": "Manual mapping giữa PaymentIntent entity và PaymentIntentModel DTO",
      "code": "using ClassifiedAds.Modules.Subscription.Entities;\nusing System.Collections.Generic;\nusing System.Linq;\n\nnamespace ClassifiedAds.Modules.Subscription.Models;\n\npublic static class PaymentIntentModelMappingConfiguration\n{\n    public static PaymentIntentModel ToModel(this PaymentIntent entity)\n    {\n        if (entity == null)\n        {\n            return null;\n        }\n\n        return new PaymentIntentModel\n        {\n            Id = entity.Id,\n            UserId = entity.UserId,\n            Amount = entity.Amount,\n            Currency = entity.Currency,\n            Purpose = entity.Purpose,\n            PlanId = entity.PlanId,\n            PlanName = entity.Plan?.DisplayName ?? entity.Plan?.Name,\n            BillingCycle = entity.BillingCycle,\n            SubscriptionId = entity.SubscriptionId,\n            Status = entity.Status,\n            CheckoutUrl = entity.CheckoutUrl,\n            ExpiresAt = entity.ExpiresAt,\n            OrderCode = entity.OrderCode,\n            CreatedDateTime = entity.CreatedDateTime,\n            UpdatedDateTime = entity.UpdatedDateTime,\n        };\n    }\n\n    public static List<PaymentIntentModel> ToModels(this IEnumerable<PaymentIntent> entities)\n    {\n        return entities?.Select(x => x.ToModel()).ToList() ?? new List<PaymentIntentModel>();\n    }\n}"
    },

    "existingModels": {
      "PaymentTransactionModel": {
        "file": "ClassifiedAds.Modules.Subscription/Models/PaymentTransactionModel.cs",
        "description": "Đã tồn tại - cần thêm Provider, ProviderRef, PaymentIntentId",
        "proposedAdditions": [
          "public Guid? PaymentIntentId { get; set; }",
          "public string Provider { get; set; }",
          "public string ProviderRef { get; set; }"
        ]
      },
      "AddPaymentTransactionModel": {
        "file": "ClassifiedAds.Modules.Subscription/Models/AddPaymentTransactionModel.cs",
        "description": "Đã tồn tại - cần thêm Provider, ProviderRef fields",
        "proposedAdditions": [
          "[StringLength(20)]\npublic string Provider { get; set; }",
          "[StringLength(200)]\npublic string ProviderRef { get; set; }"
        ]
      },
      "SubscriptionModel": {
        "file": "ClassifiedAds.Modules.Subscription/Models/SubscriptionModel.cs",
        "description": "Đã tồn tại - giữ nguyên, được dùng trong SubscriptionPurchaseResultModel"
      }
    }
  },

  "configuration": {
    "PayOsOptions": {
      "file": "ClassifiedAds.Modules.Subscription/ConfigurationOptions/PayOsOptions.cs",
      "description": "PayOS gateway configuration. Được bind từ appsettings section 'PayOS'.",
      "code": "namespace ClassifiedAds.Modules.Subscription.ConfigurationOptions;\n\n/// <summary>\n/// Configuration options for PayOS payment gateway integration.\n/// </summary>\npublic class PayOsOptions\n{\n    /// <summary>PayOS Client ID from dashboard.</summary>\n    public string ClientId { get; set; } = string.Empty;\n\n    /// <summary>PayOS API Key from dashboard.</summary>\n    public string ApiKey { get; set; } = string.Empty;\n\n    /// <summary>PayOS Secret Key (used for HMAC-SHA256 signature).</summary>\n    public string SecretKey { get; set; } = string.Empty;\n\n    /// <summary>PayOS API base URL.</summary>\n    public string BaseUrl { get; set; } = \"https://api-merchant.payos.vn\";\n\n    /// <summary>Default return URL after payment (backend endpoint).</summary>\n    public string ReturnUrl { get; set; } = string.Empty;\n\n    /// <summary>Webhook URL for PayOS to send payment status updates.</summary>\n    public string WebhookUrl { get; set; } = string.Empty;\n\n    /// <summary>Cancel URL (optional, defaults to ReturnUrl).</summary>\n    public string CancelUrl { get; set; }\n\n    /// <summary>Frontend base URL for redirecting after payment.</summary>\n    public string FrontendBaseUrl { get; set; } = string.Empty;\n\n    /// <summary>PayOS payment intent expiration time.</summary>\n    public int IntentExpirationMinutes { get; set; } = 15;\n}",
      "appsettingsExample": {
        "PayOS": {
          "ClientId": "your-client-id-from-payos-dashboard",
          "ApiKey": "your-api-key-from-payos-dashboard",
          "SecretKey": "your-secret-key-from-payos-dashboard",
          "BaseUrl": "https://api-merchant.payos.vn",
          "ReturnUrl": "https://your-api-domain.com/api/payments/payos/return",
          "WebhookUrl": "https://your-api-domain.com/api/payments/payos/webhook",
          "CancelUrl": "https://your-frontend.com/payment/cancel",
          "FrontendBaseUrl": "https://your-frontend.com",
          "IntentExpirationMinutes": 15
        }
      }
    },

    "SubscriptionModuleOptions": {
      "file": "ClassifiedAds.Modules.Subscription/ConfigurationOptions/SubscriptionModuleOptions.cs",
      "description": "Module options đã tồn tại. Thêm PayOsOptions vào.",
      "currentCode": "namespace ClassifiedAds.Modules.Subscription.ConfigurationOptions;\n\npublic class SubscriptionModuleOptions\n{\n    public ConnectionStringsOptions ConnectionStrings { get; set; }\n}",
      "proposedCode": "namespace ClassifiedAds.Modules.Subscription.ConfigurationOptions;\n\npublic class SubscriptionModuleOptions\n{\n    public ConnectionStringsOptions ConnectionStrings { get; set; }\n\n    public PayOsOptions PayOS { get; set; } = new();\n}"
    }
  },

  "dependencyInjection": {
    "file": "ClassifiedAds.Modules.Subscription/ServiceCollectionExtensions.cs",
    "description": "Cập nhật DI registration để thêm PaymentIntent repository, PayOS service, và PayOS options.",
    "addedRegistrations": [
      "// PaymentIntent repository",
      "services.AddScoped<IRepository<PaymentIntent, Guid>, Repository<PaymentIntent, Guid>>();",
      "",
      "// PayOS configuration",
      "services.Configure<PayOsOptions>(opt => { opt.ClientId = settings.PayOS.ClientId; opt.ApiKey = settings.PayOS.ApiKey; opt.SecretKey = settings.PayOS.SecretKey; opt.BaseUrl = settings.PayOS.BaseUrl; opt.ReturnUrl = settings.PayOS.ReturnUrl; opt.WebhookUrl = settings.PayOS.WebhookUrl; opt.CancelUrl = settings.PayOS.CancelUrl; opt.FrontendBaseUrl = settings.PayOS.FrontendBaseUrl; opt.IntentExpirationMinutes = settings.PayOS.IntentExpirationMinutes; });",
      "",
      "// PayOS HTTP client (typed HttpClient pattern)",
      "services.AddHttpClient<IPayOsService, PayOsService>();"
    ],
    "fullProposedMethod": "public static IServiceCollection AddSubscriptionModule(this IServiceCollection services, Action<SubscriptionModuleOptions> configureOptions)\n{\n    var settings = new SubscriptionModuleOptions();\n    configureOptions(settings);\n    settings.ConnectionStrings ??= new ConnectionStringsOptions();\n\n    services.Configure(configureOptions);\n\n    if (string.IsNullOrWhiteSpace(settings.ConnectionStrings.Default))\n    {\n        throw new InvalidOperationException(\"Chưa cấu hình chuỗi kết nối cho module Subscription.\");\n    }\n\n    services.AddDbContext<SubscriptionDbContext>(options => options.UseNpgsql(settings.ConnectionStrings.Default, sql =>\n    {\n        if (!string.IsNullOrEmpty(settings.ConnectionStrings.MigrationsAssembly))\n        {\n            sql.MigrationsAssembly(settings.ConnectionStrings.MigrationsAssembly);\n        }\n\n        if (settings.ConnectionStrings.CommandTimeout.HasValue)\n        {\n            sql.CommandTimeout(settings.ConnectionStrings.CommandTimeout);\n        }\n    }));\n\n    services\n        .AddScoped<IRepository<SubscriptionPlan, Guid>, Repository<SubscriptionPlan, Guid>>()\n        .AddScoped<IRepository<PlanLimit, Guid>, Repository<PlanLimit, Guid>>()\n        .AddScoped<IRepository<UserSubscription, Guid>, Repository<UserSubscription, Guid>>()\n        .AddScoped<IRepository<SubscriptionHistory, Guid>, Repository<SubscriptionHistory, Guid>>()\n        .AddScoped<IRepository<UsageTracking, Guid>, Repository<UsageTracking, Guid>>()\n        .AddScoped<IRepository<PaymentTransaction, Guid>, Repository<PaymentTransaction, Guid>>()\n        .AddScoped<IRepository<PaymentIntent, Guid>, Repository<PaymentIntent, Guid>>()\n        .AddScoped<IRepository<AuditLogEntry, Guid>, Repository<AuditLogEntry, Guid>>()\n        .AddScoped<IRepository<OutboxMessage, Guid>, Repository<OutboxMessage, Guid>>();\n\n    // PayOS configuration & service\n    services.Configure<PayOsOptions>(opt =>\n    {\n        var payos = settings.PayOS ?? new PayOsOptions();\n        opt.ClientId = payos.ClientId;\n        opt.ApiKey = payos.ApiKey;\n        opt.SecretKey = payos.SecretKey;\n        opt.BaseUrl = payos.BaseUrl;\n        opt.ReturnUrl = payos.ReturnUrl;\n        opt.WebhookUrl = payos.WebhookUrl;\n        opt.CancelUrl = payos.CancelUrl;\n        opt.FrontendBaseUrl = payos.FrontendBaseUrl;\n        opt.IntentExpirationMinutes = payos.IntentExpirationMinutes;\n    });\n\n    services.AddHttpClient<IPayOsService, PayOsService>();\n\n    services.AddMessageHandlers(Assembly.GetExecutingAssembly());\n    services.AddAuthorizationPolicies(Assembly.GetExecutingAssembly());\n\n    services.AddRateLimiter(options =>\n    {\n        options.AddPolicy<string, DefaultRateLimiterPolicy>(RateLimiterPolicyNames.DefaultPolicy);\n    });\n\n    return services;\n}",
    "webApiRegistration": {
      "file": "ClassifiedAds.WebAPI/Program.cs",
      "description": "Cập nhật cấu hình module trong Program.cs để truyền PayOS options",
      "example": "services.AddSubscriptionModule(opt =>\n{\n    opt.ConnectionStrings = new ConnectionStringsOptions\n    {\n        Default = connectionString,\n        MigrationsAssembly = typeof(Program).Assembly.GetName().Name,\n    };\n    opt.PayOS = new PayOsOptions\n    {\n        ClientId = configuration[\"PayOS:ClientId\"],\n        ApiKey = configuration[\"PayOS:ApiKey\"],\n        SecretKey = configuration[\"PayOS:SecretKey\"],\n        BaseUrl = configuration[\"PayOS:BaseUrl\"] ?? \"https://api-merchant.payos.vn\",\n        ReturnUrl = configuration[\"PayOS:ReturnUrl\"],\n        WebhookUrl = configuration[\"PayOS:WebhookUrl\"],\n        CancelUrl = configuration[\"PayOS:CancelUrl\"],\n        FrontendBaseUrl = configuration[\"PayOS:FrontendBaseUrl\"],\n    };\n});"
    }
  },

  "permissions": {
    "file": "ClassifiedAds.Modules.Subscription/Authorization/Permissions.cs",
    "description": "Thêm permissions cho payment endpoints",
    "addedPermissions": {
      "CreateSubscriptionPayment": "Permission:CreateSubscriptionPayment",
      "GetPaymentIntent": "Permission:GetPaymentIntent",
      "CreatePayOsCheckout": "Permission:CreatePayOsCheckout",
      "SyncPayment": "Permission:SyncPayment"
    },
    "proposedCode": "namespace ClassifiedAds.Modules.Subscription.Authorization;\n\npublic static class Permissions\n{\n    // Plans\n    public const string GetPlans = \"Permission:GetPlans\";\n    public const string AddPlan = \"Permission:AddPlan\";\n    public const string UpdatePlan = \"Permission:UpdatePlan\";\n    public const string DeletePlan = \"Permission:DeletePlan\";\n    public const string GetPlanAuditLogs = \"Permission:GetPlanAuditLogs\";\n\n    // Subscriptions\n    public const string GetSubscription = \"Permission:GetSubscription\";\n    public const string GetCurrentSubscription = \"Permission:GetCurrentSubscription\";\n    public const string AddSubscription = \"Permission:AddSubscription\";\n    public const string UpdateSubscription = \"Permission:UpdateSubscription\";\n    public const string CancelSubscription = \"Permission:CancelSubscription\";\n    public const string GetSubscriptionHistory = \"Permission:GetSubscriptionHistory\";\n    public const string GetPaymentTransactions = \"Permission:GetPaymentTransactions\";\n    public const string AddPaymentTransaction = \"Permission:AddPaymentTransaction\";\n    public const string GetUsageTracking = \"Permission:GetUsageTracking\";\n    public const string UpdateUsageTracking = \"Permission:UpdateUsageTracking\";\n\n    // Payments (PayOS)\n    public const string CreateSubscriptionPayment = \"Permission:CreateSubscriptionPayment\";\n    public const string GetPaymentIntent = \"Permission:GetPaymentIntent\";\n    public const string CreatePayOsCheckout = \"Permission:CreatePayOsCheckout\";\n    public const string SyncPayment = \"Permission:SyncPayment\";\n}"
  },

  "rateLimiting": {
    "file": "ClassifiedAds.Modules.Subscription/RateLimiterPolicies/",
    "description": "Sử dụng DefaultRateLimiterPolicy đã có. Webhook endpoint dùng AllowAnonymous, không rate limit riêng hoặc tạo policy riêng nếu cần.",
    "existingPolicy": "RateLimiterPolicyNames.DefaultPolicy",
    "note": "Có thể tạo thêm PaymentWritePolicy và PaymentWebhookPolicy nếu cần phân biệt rate limit cho payment vs subscription endpoints."
  },

  "environmentVariables": {
    "description": "Thêm vào .env hoặc appsettings.Development.json",
    "required": [
      "PayOS__ClientId",
      "PayOS__ApiKey",
      "PayOS__SecretKey"
    ],
    "optional": [
      "PayOS__BaseUrl (default: https://api-merchant.payos.vn)",
      "PayOS__ReturnUrl",
      "PayOS__WebhookUrl",
      "PayOS__CancelUrl",
      "PayOS__FrontendBaseUrl",
      "PayOS__IntentExpirationMinutes (default: 15)"
    ]
  }
}
